<!DOCTYPE html>
<html lang="en">

<!-- <div id="graph-container" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div> -->

<script src="https://d3js.org/d3.v7.min.js"></script>

<head>
    <meta charset="UTF-8">
    <title>DUG LLM Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .button-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
        }
        
        .contact-us {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            font-size: 13px;
            max-width: 60%;
        }

        .disclaimer-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            font-size: 11px;
            max-width: 60%;
        }

        .query-btn {
            flex: 1;
            margin: 5px 10px;
            padding: 10px;
            text-align: center;
            transition: height 0.3s;
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }

        .banner-container {
            width: 80%;
            display: flex;
            align-items: center;
        }

        .banner {
            width: 35%;
            height: auto;
            display: block;
        }

        .chat-input-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 10px;
        }

        .chat-input-container textarea {
            margin: 5px 10px;
            padding: 10px;
            flex: 2;
            font-size: 14px;
            resize: none;
            overflow: hidden;
            box-sizing: border-box;
        }

        .send-btn-container {
            display: flex;
            flex-direction: column;
            justify-content: stretch;
            flex: 1;
            max-width: 20%;
            padding-right: 20px;
        }

        .send-btn-container button {
            padding: 10px;
            text-align: center;
            height: 100%;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            gap: 5px;
            padding-right: 20px;
            max-width: 15%;
        }

        .btn-group button {
            padding: 10px;
            text-align: center;
            border: none;
            width: 100%;
            height: 50%;
        }

        /* Clear Chat specific styles */
        .clear-chat-btn {
            background-color: red;
            color: white;
        }

        /* Ensure buttons and text area are responsive on smaller screens */
        @media (max-width: 900px) {
            .chat-input-container {
                flex-direction: column;
            }

            .send-btn-container,
            .btn-group,
            .chat-input-container textarea {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }

        /* .graph-container {
            margin: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            padding: 10px;
            width: 100%;
        } */

        .tooltip {
            position: absolute;
            visibility: hidden;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
        }

        .chat-response-container {
            display: flex;
            flex-direction: row;
            gap: 10px;
            margin: 10px 0;
        }

        .response-container {
            flex: 1; /* Takes 50% width */
            overflow-wrap: break-word; /* Ensure long texts wrap correctly */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .graph-container {
    position: relative;
    display: block;
    width: 100%; /* Expand to full width initially */
    height: auto; /* Allow height to adjust dynamically */
    overflow: visible; /* Ensure no content is clipped */
    border: 1px solid #ddd; /* Optional for visual feedback */
    background-color: #f9f9f9; /* Optional for aesthetics */
    transition: width 0.2s ease, height 0.2s ease; /* Smooth resizing */
}



    </style>
</head>

<body class="light-mode">
    <button id="toggle-mode-btn" class="toggle-button"><i class="fas fa-sun"></i></button>

    <div class="banner-container">
         <img src="{{ banner_image_url }}" alt="Banner" class="banner">
    </div>
    <br />
    <div class="button-container">
        <h5>Generate questions<br />on topics of interest:</h5>
        <button class="query-btn" data-query="asthma">asthma</button>
        <button class="query-btn" data-query="genomics">genomics</button>
        <button class="query-btn" data-query="cardiovascular disease">heart disease</button>
        <button class="query-btn" data-query="atherosclerosis">atherosclerosis</button>
        <button class="query-btn" data-query="sickle cell">sickle cell</button>
    </div>
    <div class="chat-container">
        <div class="chat-box" id="chat-box">
            <div class="chat-message bot-message">Hello! What can I help you find today?</div>
        </div>
        <div class="chat-input-container">
            <!-- Text area input -->
            <textarea id="user-input" placeholder="Ask your question here (e.g. 'find COPD studies', 'who is studying cocaine addiction?', etc.)"
                      rows="1" autofocus></textarea>

            <!-- Column 1: Send Button -->
            <div class="send-btn-container">
                <button id="send-btn">Send</button>
            </div>

            <!-- Column 2: Export and Clear Chat Buttons stacked -->
            <div class="btn-group">
                <button id="export-btn">Export chat history</button>
                <button id="clear-chat-btn" class="clear-chat-btn">Clear Chat</button>
            </div>
        </div>
    </div>
    <div class="contact-us">
        <p>For questions or feedback, please visit <a href="http://link-to-google-form">[link to google form]</a>. For more information about the BioData Catalyst, please visit <a href="https://biodatacatalyst.nhlbi.nih.gov/">https://biodatacatalyst.nhlbi.nih.gov/</a>.
        </p>
    </div>
    <div class="disclaimer-container">
        <p>Disclaimer:</p>
        <p><ul>
            <li>The chatbot logs will be de-identified and preserved by the BioData Catalyst Study Chatbot Team for quality assurance purposes, though not shared with the public.</li>
            <li>The chatbot is designed to answer queries about study abstracts and find studies that might be relevant to the user. Any queries outside of that core scope might result in inaccurate, erroneous, or fabricated responses due to design principles of the underlying LLM. Please exercise caution when executing such queries.</li>
            <li>The chatbot does not have full implementation of content moderation guardrails, and therefore conversations outside of the abovementioned scope may result in uncouth or inappropriate responses.</li>
        </p>
        </ul></p>
    </div>

    <script>
        function renderGraph(data, containerId) {
    // Clear any existing graph content
    d3.select(`#${containerId}`).select("svg").remove();

    const container = document.getElementById(containerId);

    // Initial dimensions for the container
    const width = container.offsetWidth || 800; // Default width if offsetWidth is unavailable
    const height = 500; // Initial height

    // Create the SVG container
    const svg = d3.select(`#${containerId}`).append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio", "xMidYMid meet");

    // Define arrowhead marker
    svg.append("defs").append("marker")
        .attr("id", "arrowhead")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 15)
        .attr("refY", 0)
        .attr("markerWidth", 6)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M0,-5L10,0L0,5")
        .attr("fill", "#999");

    // Add links (edges)
    const link = svg.selectAll(".link")
        .data(data.edges)
        .enter().append("line")
        .attr("class", "link")
        .attr("marker-end", "url(#arrowhead)")
        .style("stroke", "#999")
        .style("stroke-width", 1.5);

    // Add nodes
    const node = svg.selectAll(".node")
        .data(data.nodes)
        .enter().append("g")
        .attr("class", "node")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    node.append("circle")
        .attr("r", 8)
        .style("fill", "#69b3a2");

    node.append("text")
        .attr("dx", 12)
        .attr("dy", ".35em")
        .text(d => d.name);

    // Force simulation
    const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
        .force("charge", d3.forceManyBody().strength(-300))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked)
        .on("end", adjustContainerSize); // Adjust size after layout is stable

    function ticked() {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node.attr("transform", d => `translate(${d.x},${d.y})`);
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    // Adjust container size based on the graph's bounding box
    function adjustContainerSize() {
        // Calculate bounds
        const bounds = svg.node().getBBox();
        const padding = 20; // Add padding around the graph
        const adjustedWidth = bounds.width + padding * 2;
        const adjustedHeight = bounds.height + padding * 2;

        // Update SVG dimensions
        svg
            .attr("viewBox", `${bounds.x - padding} ${bounds.y - padding} ${adjustedWidth} ${adjustedHeight}`)
            .attr("width", adjustedWidth)
            .attr("height", adjustedHeight);

        // Dynamically update the container size
        container.style.width = `${adjustedWidth}px`;
        container.style.height = `${adjustedHeight}px`;
    }
}




    

        $(document).ready(function () {
            // Auto-expand textarea as the user types
            $('#user-input').on('input', function () {
                this.style.height = 'auto';  // Reset height to auto to adjust for shrinking
                this.style.height = (this.scrollHeight) + 'px';  // Set height based on scrollHeight
            });


            function sendMessage(message) {
                $('#chat-box').append('<div class="chat-message user-message">' + message + '</div>');
                $('#user-input').val('');
                $('#user-input').css('height', 'auto'); // Reset height after sending the message

                var spinner = '<div class="chat-message bot-message spinner"><i class="fas fa-circle-notch fa-spin"></i></div>';
                $('#chat-box').append(spinner);
                scrollToBottom();

                $.post("{{ url_for('get_response') }}", { message: message }, function (data) {
                $('#chat-box .spinner').remove();

                // Append the response to the chat box
                const botMessage = `<div class="chat-message bot-message">${data.response}</div>`;
                $('#chat-box').append(botMessage);

                // If a knowledge graph is present, append a graph container and render it
                if (data.knowledge_graph) {
                    const graphContainerId = `graph-container-${Date.now()}`;
                    const graphContainer = `<div id="${graphContainerId}" class="graph-container"></div>`;
                    $('#chat-box').append(graphContainer);

                    const graphData = {
                        nodes: data.knowledge_graph.nodes.map(node => ({
                            id: node.id,
                            name: node.name,
                            category: node.category
                        })),
                        edges: data.knowledge_graph.edges.map(edge => ({
                            source: edge.subject,
                            target: edge.object,
                            predicate: edge.predicate,
                            predicate_label: edge.predicate_label
                        }))
                    };

                    renderGraph(graphData, graphContainerId);
                }

                scrollToBottom();
            });

            }

            function scrollToBottom() {
                var chatBox = $('#chat-box');
                chatBox.scrollTop(chatBox.prop("scrollHeight"));
            }

            $('#send-btn').click(function () {
                var userMessage = $('#user-input').val();
                if (userMessage.trim() !== '') {
                    sendMessage(userMessage);
                }
            });

            $('.query-btn').click(function () {
                var topicQuery = $(this).data('query');

                if (topicQuery === 'sickle cell') {
                    // Predefined list of questions for "sickle cell"
                    var sickleCellQuestions = [
                        "What type of conditioning regimen was used in the study for patients with sickle cell disease undergoing bone marrow transplantation.",
                        "What specific neurologic criteria were used to include patients with sickle cell disease in the study on unrelated donor hematopoietic stem cell transplantation.",
                        "What was the dose of Melphalan administered in the study on unrelated donor hematopoietic stem cell transplantation for sickle cell disease.",
                        "What was the primary outcome measured in the study on unrelated donor hematopoietic stem cell transplantation for sickle cell disease.",
                        "What is the primary symptom of pulmonary arterial hypertension in sickle cell disease.",
                        "How many infants were enrolled during Phase 1 of the Cooperative Study of Sickle Cell Disease.",
                        "What percentage of patients with severe sickle cell disease have an HLA-matched sibling donor."
                    ];
                    var randomQuery = sickleCellQuestions[Math.floor(Math.random() * sickleCellQuestions.length)];
                } else {
                    // Default query template for other topics
                    var queryTemplate = [
                        "What are some major findings in " + topicQuery + " research?",
                        "Find recent studies on " + topicQuery,
                        "Is anyone investigating " + topicQuery + "?",
                        "What are the current trends in " + topicQuery + " research?",
                        "Who is studying " + topicQuery + "?",
                        "What are the most common keywords in " + topicQuery + " research?",
                        "What are the most common study designs in " + topicQuery + " research?"
                    ];
                    var randomQuery = queryTemplate[Math.floor(Math.random() * queryTemplate.length)];
                }
                sendMessage(randomQuery);
            });

            $('#user-input').keypress(function (e) {
                if (e.which == 13) { // Enter key pressed
                    $('#send-btn').click();
                }
            });

            $('#toggle-mode-btn').click(function () {
                $('body').toggleClass('dark-mode light-mode');
                $('i', this).toggleClass('fa-sun fa-moon');
            });

            $('#export-btn').click(function () {
                window.location.href = "{{ url_for('export_chat_history') }}";
            });

            // Clear chat history with confirmation
            $('#clear-chat-btn').click(function () {
                if (confirm("Are you sure you want to clear the chat history?")) {
                    $.post("{{ url_for('clear_history') }}", function (data) {
                        if (data.status === 'success') {
                            $('#chat-box').empty();  // Clear the chat box in the frontend
                            $('#chat-box').append('<div class="chat-message bot-message">You have cleared the chat history. What can I help you find today?</div>');
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>
