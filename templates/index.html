<!DOCTYPE html>
<html lang="en">

<div id="graph-container" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>


<script>
    // function renderGraph(data, containerId) {
    //     // Clear any existing graph content in the container
    //     d3.select(`#${containerId}`).select("svg").remove();

    //     const container = document.getElementById(containerId);
    //     const width = container.offsetWidth;
    //     const height = 300; // Fixed height for the graph

    //     const svg = d3.select(`#${containerId}`).append("svg")
    //         .attr("width", width)
    //         .attr("height", height);

    //     const link = svg.selectAll(".link")
    //         .data(data.edges)
    //         .enter().append("line")
    //         .attr("class", "link")
    //         .style("stroke", "#999")
    //         .style("stroke-width", 1.5);

    //     const node = svg.selectAll(".node")
    //         .data(data.nodes)
    //         .enter().append("g")
    //         .attr("class", "node")
    //         .call(d3.drag()
    //             .on("start", dragstarted)
    //             .on("drag", dragged)
    //             .on("end", dragended));

    //     node.append("circle")
    //         .attr("r", 8)
    //         .style("fill", "#69b3a2");

    //     node.append("text")
    //         .attr("dx", 12)
    //         .attr("dy", ".35em")
    //         .text(d => d.name);

    //     const simulation = d3.forceSimulation(data.nodes)
    //         .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
    //         .force("charge", d3.forceManyBody().strength(-300))
    //         .force("center", d3.forceCenter(width / 2, height / 2))
    //         .on("tick", ticked);

    //     function ticked() {
    //         link
    //             .attr("x1", d => d.source.x)
    //             .attr("y1", d => d.source.y)
    //             .attr("x2", d => d.target.x)
    //             .attr("y2", d => d.target.y);

    //         node.attr("transform", d => `translate(${d.x},${d.y})`);
    //     }

    //     function dragstarted(event, d) {
    //         if (!event.active) simulation.alphaTarget(0.3).restart();
    //         d.fx = d.x;
    //         d.fy = d.y;
    //     }

    //     function dragged(event, d) {
    //         d.fx = event.x;
    //         d.fy = event.y;
    //     }

    //     function dragended(event, d) {
    //         if (!event.active) simulation.alphaTarget(0);
    //         d.fx = null;
    //         d.fy = null;
    //     }
    // }

    // # best one so far
    // function renderGraph(data, containerId) {
    //     // Clear any existing graph content in the container
    //     d3.select(`#${containerId}`).select("svg").remove();
    //     d3.select(`#${containerId}`).select(".tooltip").remove();

    //     const container = document.getElementById(containerId);
    //     const width = container.offsetWidth;
    //     const height = 300; // Fixed height for the graph

    //     // Create the SVG container
    //     const svg = d3.select(`#${containerId}`).append("svg")
    //         .attr("width", width)
    //         .attr("height", height);

    //     // Create a custom tooltip
    //     const tooltip = d3.select(`#${containerId}`).append("div")
    //         .attr("class", "tooltip")
    //         .style("position", "absolute")
    //         .style("visibility", "hidden")
    //         .style("background", "rgba(0, 0, 0, 0.8)")
    //         .style("color", "#fff")
    //         .style("padding", "5px 10px")
    //         .style("border-radius", "5px")
    //         .style("font-size", "12px")
    //         .style("pointer-events", "none");

    //     // Add links (edges)
    //     const link = svg.selectAll(".link")
    //         .data(data.edges)
    //         .enter().append("line")
    //         .attr("class", "link")
    //         .style("stroke", "#999")
    //         .style("stroke-width", 1.5)
    //         .on("mouseover", function (event, d) {
    //             tooltip.html(
    //                 `${d.source.name} - ${d.predicate} - ${d.target.name}<br>` +
    //                 `${d.target.name} - ${d.relation} - ${d.source.name}`
    //             );
    //             tooltip.style("visibility", "visible");
    //         })
    //         .on("mousemove", function (event) {
    //             tooltip.style("top", `${event.pageY + 10}px`).style("left", `${event.pageX + 10}px`);
    //         })
    //         .on("mouseout", function () {
    //             tooltip.style("visibility", "hidden");
    //         });

    //     // Add nodes
    //     const node = svg.selectAll(".node")
    //         .data(data.nodes)
    //         .enter().append("g")
    //         .attr("class", "node")
    //         .call(d3.drag()
    //             .on("start", dragstarted)
    //             .on("drag", dragged)
    //             .on("end", dragended));

    //     // Add circles for nodes
    //     node.append("circle")
    //         .attr("r", 8)
    //         .style("fill", "#69b3a2")
    //         .on("mouseover", function (event, d) {
    //             // tooltip.html(
    //             //     `<strong>${d.name}</strong><br>` +
    //             //     `<strong>Category:</strong> ${d.category.join(", ")}<br>` +
    //             //     `<strong>Description:</strong> ${d.description || "N/A"}`
    //             // );
    //             // tooltip.html(
    //             //     `<strong>Name: ${d.name}</strong><br>` +
    //             //     `<strong>Category:</strong><br>` +
    //             //     `${d.category.map(cat => `&nbsp;&nbsp;&nbsp;&nbsp;- ${cat}`).join("<br>")}<br>` +
    //             //     `<strong>Description:</strong> ${d.description || "N/A"}`
    //             // );
    //             tooltip.html(
    //                 `<strong>${d.name}</strong><br>` +
    //                 `<strong>Category:</strong> ${
    //                     d.category.length === 1
    //                         ? d.category[0] // Single category, display inline
    //                         : "<br>" + d.category.map(cat => `&nbsp;&nbsp;&nbsp;&nbsp;- ${cat}`).join("<br>") // Multiple categories as a list
    //                 }<br>` +
    //                 `<strong>Description:</strong> ${d.description || "N/A"}`
    //             );


    //             tooltip.style("visibility", "visible");
    //         })
    //         .on("mousemove", function (event) {
    //             tooltip.style("top", `${event.pageY + 10}px`).style("left", `${event.pageX + 10}px`);
    //         })
    //         .on("mouseout", function () {
    //             // tooltip.style("visibility", "hidden");
    //             tooltip.style("visibility", "visible");
    //         });

    //     // Add labels for nodes
    //     node.append("text")
    //         .attr("dx", 12)
    //         .attr("dy", ".35em")
    //         .text(d => d.name);

    //     // Simulation for force-directed layout
    //     const simulation = d3.forceSimulation(data.nodes)
    //         .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
    //         .force("charge", d3.forceManyBody().strength(-300))
    //         .force("center", d3.forceCenter(width / 2, height / 2))
    //         .on("tick", ticked);

    //     function ticked() {
    //         link
    //             .attr("x1", d => d.source.x)
    //             .attr("y1", d => d.source.y)
    //             .attr("x2", d => d.target.x)
    //             .attr("y2", d => d.target.y);

    //         node.attr("transform", d => `translate(${d.x},${d.y})`);
    //     }

    //     function dragstarted(event, d) {
    //         if (!event.active) simulation.alphaTarget(0.3).restart();
    //         d.fx = d.x;
    //         d.fy = d.y;
    //     }

    //     function dragged(event, d) {
    //         d.fx = event.x;
    //         d.fy = event.y;
    //     }

    //     function dragended(event, d) {
    //         if (!event.active) simulation.alphaTarget(0);
    //         d.fx = null;
    //         d.fy = null;
    //     }
    // }

    // function renderGraph(data, containerId) {
    //     // Clear any existing graph content in the container
    //     d3.select(`#${containerId}`).select("svg").remove();

    //     const container = document.getElementById(containerId);
    //     const width = container.offsetWidth;
    //     const height = 300; // Fixed height for the graph

    //     // Create the SVG container
    //     const svg = d3.select(`#${containerId}`).append("svg")
    //         .attr("width", width)
    //         .attr("height", height);

    //     // Add links (edges)
    //     const link = svg.selectAll(".link")
    //         .data(data.edges)
    //         .enter().append("line")
    //         .attr("class", "link")
    //         .style("stroke", "#999")
    //         .style("stroke-width", 1.5);

    //     // Add static tooltips for edges
    //     const edgeTooltip = svg.selectAll(".edge-tooltip")
    //         .data(data.edges)
    //         .enter().append("text")
    //         .attr("class", "edge-tooltip")
    //         .attr("x", d => (d.source.x + d.target.x) / 2) // Initial midpoint position
    //         .attr("y", d => (d.source.y + d.target.y) / 2)
    //         .style("font-size", "10px")
    //         .style("fill", "#555")
    //         .text(d => 
    //             `${d.source.name} - ${d.predicate} - ${d.target.name}\n` +
    //             `${d.target.name} - ${d.relation} - ${d.source.name}`
    //         );

    //     // Add nodes
    //     const node = svg.selectAll(".node")
    //         .data(data.nodes)
    //         .enter().append("g")
    //         .attr("class", "node")
    //         .call(d3.drag()
    //             .on("start", dragstarted)
    //             .on("drag", dragged)
    //             .on("end", dragended));

    //     // Add circles for nodes
    //     node.append("circle")
    //         .attr("r", 8)
    //         .style("fill", "#69b3a2");

    //     // Add static tooltips for nodes
    //     const nodeTooltip = svg.selectAll(".node-tooltip")
    //         .data(data.nodes)
    //         .enter().append("text")
    //         .attr("class", "node-tooltip")
    //         .attr("x", d => d.x + 15) // Offset tooltip position to the right
    //         .attr("y", d => d.y - 10) // Offset tooltip position slightly above
    //         .style("font-size", "10px")
    //         .style("fill", "#333")
    //         .text(d => {
    //             if (d.category.length === 1) {
    //                 return `${d.name}: ${d.category[0]}`;
    //             } else {
    //                 const categories = d.category.map(cat => `- ${cat}`).join(", ");
    //                 return `${d.name}: ${categories}`;
    //             }
    //         });

    //     // Simulation for force-directed layout
    //     const simulation = d3.forceSimulation(data.nodes)
    //         .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
    //         .force("charge", d3.forceManyBody().strength(-300))
    //         .force("center", d3.forceCenter(width / 2, height / 2))
    //         .on("tick", ticked);

    //     function ticked() {
    //         link
    //             .attr("x1", d => d.source.x)
    //             .attr("y1", d => d.source.y)
    //             .attr("x2", d => d.target.x)
    //             .attr("y2", d => d.target.y);

    //         edgeTooltip
    //             .attr("x", d => (d.source.x + d.target.x) / 2)
    //             .attr("y", d => (d.source.y + d.target.y) / 2);

    //         node.attr("transform", d => `translate(${d.x},${d.y})`);

    //         nodeTooltip
    //             .attr("x", d => d.x + 15) // Offset tooltip position to the right
    //             .attr("y", d => d.y - 10); // Offset tooltip position slightly above
    //     }

    //     function dragstarted(event, d) {
    //         if (!event.active) simulation.alphaTarget(0.3).restart();
    //         d.fx = d.x;
    //         d.fy = d.y;
    //     }

    //     function dragged(event, d) {
    //         d.fx = event.x;
    //         d.fy = event.y;
    //     }

    //     function dragended(event, d) {
    //         if (!event.active) simulation.alphaTarget(0);
    //         d.fx = null;
    //         d.fy = null;
    //     }
    // }


//     # beta
//     function renderGraph(data, containerId) {
//     // Clear any existing graph content in the container
//     d3.select(`#${containerId}`).select("svg").remove();

//     const container = document.getElementById(containerId);
//     const width = container.offsetWidth;
//     const height = 300; // Fixed height for the graph

//     // Create the SVG container
//     const svg = d3.select(`#${containerId}`).append("svg")
//         .attr("width", width)
//         .attr("height", height);

//     // Add links (edges)
//     const link = svg.selectAll(".link")
//         .data(data.edges)
//         .enter().append("line")
//         .attr("class", "link")
//         .style("stroke", "#999")
//         .style("stroke-width", 1.5);

//     // Add edge tooltips
//     const edgeTooltip = svg.selectAll(".edge-tooltip")
//         .data(data.edges)
//         .enter().append("foreignObject")
//         .attr("class", "edge-tooltip")
//         .attr("width", 200) // Tooltip width
//         .attr("height", 100) // Tooltip height
//         .append("xhtml:div")
//         .style("font-size", "10px")
//         .style("color", "#555")
//         .style("background", "rgba(255, 255, 255, 0.9)")
//         .style("padding", "5px")
//         .style("border-radius", "5px")
//         .style("box-shadow", "0px 2px 4px rgba(0, 0, 0, 0.2)")
//         .html(d =>
//             `<strong>${d.source.name} - ${d.predicate} - ${d.target.name}</strong><br>` +
//             `<strong>${d.target.name} - ${d.relation} - ${d.source.name}</strong>`
//         );

//     // Add nodes
//     const node = svg.selectAll(".node")
//         .data(data.nodes)
//         .enter().append("g")
//         .attr("class", "node")
//         .call(d3.drag()
//             .on("start", dragstarted)
//             .on("drag", dragged)
//             .on("end", dragended));

//     // Add circles for nodes
//     node.append("circle")
//         .attr("r", 8)
//         .style("fill", "#69b3a2");

//     // Add node tooltips
//     const nodeTooltip = svg.selectAll(".node-tooltip")
//         .data(data.nodes)
//         .enter().append("foreignObject")
//         .attr("class", "node-tooltip")
//         .attr("width", 200) // Tooltip width
//         .attr("height", 100) // Tooltip height
//         .append("xhtml:div")
//         .style("font-size", "10px")
//         .style("color", "#333")
//         .style("background", "rgba(255, 255, 255, 0.9)")
//         .style("padding", "5px")
//         .style("border-radius", "5px")
//         .style("box-shadow", "0px 2px 4px rgba(0, 0, 0, 0.2)")
//         .html(d =>
//             `<strong>${d.name}</strong><br>` +
//             `<strong>Category:</strong> ${
//                 d.category.length === 1
//                     ? d.category[0] // Single category, display inline
//                     : "<br>" + d.category.map(cat => `&nbsp;&nbsp;&nbsp;&nbsp;- ${cat}`).join("<br>") // Multiple categories as a list
//             }<br>` +
//             `<strong>Description:</strong> ${d.description || "N/A"}`
//         );

//     // Simulation for force-directed layout
//     const simulation = d3.forceSimulation(data.nodes)
//         .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
//         .force("charge", d3.forceManyBody().strength(-300))
//         .force("center", d3.forceCenter(width / 2, height / 2))
//         .on("tick", ticked);

//     function ticked() {
//         // Update link positions
//         link
//             .attr("x1", d => d.source.x)
//             .attr("y1", d => d.source.y)
//             .attr("x2", d => d.target.x)
//             .attr("y2", d => d.target.y);

//         // Update edge tooltip positions
//         svg.selectAll(".edge-tooltip")
//             .attr("x", d => (d.source.x + d.target.x) / 2 - 100) // Center and align tooltip horizontally
//             .attr("y", d => (d.source.y + d.target.y) / 2 - 50); // Center and align tooltip vertically

//         // Update node positions
//         node.attr("transform", d => `translate(${d.x},${d.y})`);

//         // Update node tooltip positions
//         svg.selectAll(".node-tooltip")
//             .attr("x", d => d.x + 10) // Offset tooltip to the right
//             .attr("y", d => d.y - 20); // Offset tooltip above the node
//     }

//     function dragstarted(event, d) {
//         if (!event.active) simulation.alphaTarget(0.3).restart();
//         d.fx = d.x;
//         d.fy = d.y;
//     }

//     function dragged(event, d) {
//         d.fx = event.x;
//         d.fy = event.y;
//     }

//     function dragended(event, d) {
//         if (!event.active) simulation.alphaTarget(0);
//         d.fx = null;
//         d.fy = null;
//     }
// }
    function renderGraph(data, containerId) {
    // Clear any existing graph content in the container
    d3.select(`#${containerId}`).select("svg").remove();

    const container = document.getElementById(containerId);
    const width = container.offsetWidth;
    const height = 300; // Fixed height for the graph

    // Create the SVG container
    const svg = d3.select(`#${containerId}`).append("svg")
        .attr("width", width)
        .attr("height", height);

    // Add links (edges)
    const link = svg.selectAll(".link")
        .data(data.edges)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke", "#999")
        .style("stroke-width", 1.5);

    // Add edge tooltips
    const edgeTooltip = svg.selectAll(".edge-tooltip")
        .data(data.edges)
        .enter().append("foreignObject")
        .attr("class", "edge-tooltip")
        .attr("width", 200) // Tooltip width
        .attr("height", 100) // Tooltip height
        .append("xhtml:div")
        .style("font-size", "10px")
        .style("color", "#555")
        .style("background", "rgba(255, 255, 255, 0.9)")
        .style("padding", "5px")
        .style("border-radius", "5px")
        .style("box-shadow", "0px 2px 4px rgba(0, 0, 0, 0.2)")
        .html(d =>
            `<strong>${d.source.name} - ${d.predicate} - ${d.target.name}</strong><br>` +
            `<strong>${d.target.name} - ${d.relation} - ${d.source.name}</strong>`
        );

    // Add nodes
    const node = svg.selectAll(".node")
        .data(data.nodes)
        .enter().append("g")
        .attr("class", "node")
        .call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

    // Add circles for nodes
    node.append("circle")
        .attr("r", 8)
        .style("fill", "#69b3a2");

    // Add node tooltips
    const nodeTooltip = svg.selectAll(".node-tooltip")
        .data(data.nodes)
        .enter().append("foreignObject")
        .attr("class", "node-tooltip")
        .attr("width", 200) // Tooltip width
        .attr("height", 100) // Tooltip height
        .append("xhtml:div")
        .style("font-size", "10px")
        .style("color", "#333")
        .style("background", "rgba(255, 255, 255, 0.9)")
        .style("padding", "5px")
        .style("border-radius", "5px")
        .style("box-shadow", "0px 2px 4px rgba(0, 0, 0, 0.2)")
        .html(d =>
            `<strong>${d.name}</strong><br>` +
            `<strong>Category:</strong> ${
                d.category.length === 1
                    ? d.category[0] // Single category, display inline
                    : "<br>" + d.category.map(cat => `&nbsp;&nbsp;&nbsp;&nbsp;- ${cat}`).join("<br>") // Multiple categories as a list
            }<br>` +
            `<strong>Description:</strong> ${d.description || "N/A"}`
        );

    // Simulation for force-directed layout
    const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.edges).id(d => d.id).distance(200)) // Increased distance between connected nodes
        .force("charge", d3.forceManyBody().strength(-400)) // Stronger repulsion for better spacing
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked);

    function ticked() {
        // Update link positions
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        // Update edge tooltip positions
        svg.selectAll(".edge-tooltip")
            .attr("x", d => (d.source.x + d.target.x) / 2 - 100) // Center and align tooltip horizontally
            .attr("y", d => (d.source.y + d.target.y) / 2 - 50); // Center and align tooltip vertically

        // Update node positions
        node.attr("transform", d => `translate(${d.x},${d.y})`);

        // Update node tooltip positions
        svg.selectAll(".node-tooltip")
            .attr("x", d => d.x + 10) // Offset tooltip to the right
            .attr("y", d => d.y - 20); // Offset tooltip above the node
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}





</script>


<!-- <script>
    function renderGraph(data) {
        const width = document.getElementById('graph-container').offsetWidth;
        const height = document.getElementById('graph-container').offsetHeight;

        const svg = d3.select("#graph-container").append("svg")
            .attr("width", width)
            .attr("height", height);

        const link = svg.selectAll(".link")
            .data(data.edges)
            .enter().append("line")
            .attr("class", "link")
            .style("stroke", "#999")
            .style("stroke-width", 1.5);

        const node = svg.selectAll(".node")
            .data(data.nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        node.append("circle")
            .attr("r", 8)
            .style("fill", "#69b3a2");

        node.append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(d => d.name);

        const simulation = d3.forceSimulation(data.nodes)
            .force("link", d3.forceLink(data.edges).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-300))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .on("tick", ticked);

        function ticked() {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("transform", d => `translate(${d.x},${d.y})`);
        }

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }
</script> -->


<head>
    <meta charset="UTF-8">
    <title>DUG LLM Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .button-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
        }
        
        .contact-us {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            font-size: 13px;
            max-width: 60%;
        }

        .disclaimer-container {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            font-size: 11px;
            max-width: 60%;
        }

        .query-btn {
            flex: 1;
            margin: 5px 10px;
            padding: 10px;
            text-align: center;
            transition: height 0.3s;
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
        }

        .banner-container {
            width: 80%;
            display: flex;
            align-items: center;
        }

        .banner {
            width: 35%;
            height: auto;
            display: block;
        }

        .chat-input-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            gap: 10px;
        }

        .chat-input-container textarea {
            margin: 5px 10px;
            padding: 10px;
            flex: 2;
            font-size: 14px;
            resize: none;
            overflow: hidden;
            box-sizing: border-box;
        }

        .send-btn-container {
            display: flex;
            flex-direction: column;
            justify-content: stretch;
            flex: 1;
            max-width: 20%;
            padding-right: 20px;
        }

        .send-btn-container button {
            padding: 10px;
            text-align: center;
            height: 100%;
            box-sizing: border-box;
            width: 100%;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            flex: 1;
            gap: 5px;
            padding-right: 20px;
            max-width: 15%;
        }

        .btn-group button {
            padding: 10px;
            text-align: center;
            border: none;
            width: 100%;
            height: 50%;
        }

        /* Clear Chat specific styles */
        .clear-chat-btn {
            background-color: red;
            color: white;
        }

        /* Ensure buttons and text area are responsive on smaller screens */
        @media (max-width: 900px) {
            .chat-input-container {
                flex-direction: column;
            }

            .send-btn-container,
            .btn-group,
            .chat-input-container textarea {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }

        .graph-container {
            margin: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            padding: 10px;
            width: 100%;
        }

        .tooltip {
            position: absolute;
            visibility: hidden;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>

<body class="light-mode">
    <button id="toggle-mode-btn" class="toggle-button"><i class="fas fa-sun"></i></button>

    <div class="banner-container">
         <img src="{{ banner_image_url }}" alt="Banner" class="banner">
    </div>
    <br />
    <div class="button-container">
        <h5>Generate questions<br />on topics of interest:</h5>
        <button class="query-btn" data-query="asthma">asthma</button>
        <button class="query-btn" data-query="genomics">genomics</button>
        <button class="query-btn" data-query="cardiovascular disease">heart disease</button>
        <button class="query-btn" data-query="atherosclerosis">atherosclerosis</button>
        <button class="query-btn" data-query="sickle cell">sickle cell</button>
    </div>
    <div class="chat-container">
        <div class="chat-box" id="chat-box">
            <div class="chat-message bot-message">Hello! What can I help you find today?</div>
        </div>
        <div class="chat-input-container">
            <!-- Text area input -->
            <textarea id="user-input" placeholder="Ask your question here (e.g. 'find COPD studies', 'who is studying cocaine addiction?', etc.)"
                      rows="1" autofocus></textarea>

            <!-- Column 1: Send Button -->
            <div class="send-btn-container">
                <button id="send-btn">Send</button>
            </div>

            <!-- Column 2: Export and Clear Chat Buttons stacked -->
            <div class="btn-group">
                <button id="export-btn">Export chat history</button>
                <button id="clear-chat-btn" class="clear-chat-btn">Clear Chat</button>
            </div>
        </div>
    </div>
    <div class="contact-us">
        <p>For questions or feedback, please visit <a href="http://link-to-google-form">[link to google form]</a>. For more information about the BioData Catalyst, please visit <a href="https://biodatacatalyst.nhlbi.nih.gov/">https://biodatacatalyst.nhlbi.nih.gov/</a>.
        </p>
    </div>
    <div class="disclaimer-container">
        <p>Disclaimer:</p>
        <p><ul>
            <li>The chatbot logs will be de-identified and preserved by the BioData Catalyst Study Chatbot Team for quality assurance purposes, though not shared with the public.</li>
            <li>The chatbot is designed to answer queries about study abstracts and find studies that might be relevant to the user. Any queries outside of that core scope might result in inaccurate, erroneous, or fabricated responses due to design principles of the underlying LLM. Please exercise caution when executing such queries.</li>
            <li>The chatbot does not have full implementation of content moderation guardrails, and therefore conversations outside of the abovementioned scope may result in uncouth or inappropriate responses.</li>
        </p>
        </ul></p>
    </div>

    <script>
        $(document).ready(function () {
            // Auto-expand textarea as the user types
            $('#user-input').on('input', function () {
                this.style.height = 'auto';  // Reset height to auto to adjust for shrinking
                this.style.height = (this.scrollHeight) + 'px';  // Set height based on scrollHeight
            });

            function sendMessage(message) {
                $('#chat-box').append('<div class="chat-message user-message">' + message + '</div>');
                $('#user-input').val('');
                $('#user-input').css('height', 'auto');  // Reset height after sending the message

                var spinner = '<div class="chat-message bot-message spinner"><i class="fas fa-circle-notch fa-spin"></i></div>';
                $('#chat-box').append(spinner);
                scrollToBottom();

                // $.post("{{ url_for('get_response') }}", { message: message }, function (data) {
                //     $('#chat-box .spinner').remove();
                //     $('#chat-box').append('<div class="chat-message bot-message">' + data.response + '</div>');
                //     scrollToBottom();
                // });

                // $.post("{{ url_for('get_response') }}", { message: message }, function (data) {
                //     $('#chat-box .spinner').remove();
                //     $('#chat-box').append('<div class="chat-message bot-message">' + data.response + '</div>');

                //     if (data.knowledge_graph) {
                //         const graphData = {
                //             nodes: data.knowledge_graph.nodes,
                //             edges: data.knowledge_graph.edges.map(edge => ({
                //                 source: edge.subject,
                //                 target: edge.object,
                //                 relation: edge.predicate_label
                //             }))
                //         };
                //         $('#graph-container').empty(); // Clear previous graph
                //         renderGraph(graphData);
                //     }

                //     scrollToBottom();
                // });
                $.post("{{ url_for('get_response') }}", { message: message }, function (data) {
                    $('#chat-box .spinner').remove();

                    // Append the response to the chat box
                    const botMessage = `<div class="chat-message bot-message">${data.response}</div>`;
                    $('#chat-box').append(botMessage);

                    // If a knowledge graph is present, append a graph container and render it
                    if (data.knowledge_graph) {
                        const graphContainerId = `graph-container-${Date.now()}`;
                        const graphContainer = `<div id="${graphContainerId}" class="graph-container"></div>`;
                        $('#chat-box').append(graphContainer);

                        const graphData = {
                            nodes: data.knowledge_graph.nodes,
                            edges: data.knowledge_graph.edges.map(edge => ({
                                source: edge.subject,
                                target: edge.object,
                                predicate: edge.predicate,
                                relation: edge.relation
                            }))
                        };

                        renderGraph(graphData, graphContainerId);
                    }

                    scrollToBottom();
                });
            }

            function scrollToBottom() {
                var chatBox = $('#chat-box');
                chatBox.scrollTop(chatBox.prop("scrollHeight"));
            }

            $('#send-btn').click(function () {
                var userMessage = $('#user-input').val();
                if (userMessage.trim() !== '') {
                    sendMessage(userMessage);
                }
            });

            $('.query-btn').click(function () {
                var topicQuery = $(this).data('query');

                if (topicQuery === 'sickle cell') {
                    // Predefined list of questions for "sickle cell"
                    var sickleCellQuestions = [
                        "What type of conditioning regimen was used in the study for patients with sickle cell disease undergoing bone marrow transplantation.",
                        "What specific neurologic criteria were used to include patients with sickle cell disease in the study on unrelated donor hematopoietic stem cell transplantation.",
                        "What was the dose of Melphalan administered in the study on unrelated donor hematopoietic stem cell transplantation for sickle cell disease.",
                        "What was the primary outcome measured in the study on unrelated donor hematopoietic stem cell transplantation for sickle cell disease.",
                        "What is the primary symptom of pulmonary arterial hypertension in sickle cell disease.",
                        "How many infants were enrolled during Phase 1 of the Cooperative Study of Sickle Cell Disease.",
                        "What percentage of patients with severe sickle cell disease have an HLA-matched sibling donor."
                    ];
                    var randomQuery = sickleCellQuestions[Math.floor(Math.random() * sickleCellQuestions.length)];
                } else {
                    // Default query template for other topics
                    var queryTemplate = [
                        "What are some major findings in " + topicQuery + " research?",
                        "Find recent studies on " + topicQuery,
                        "Is anyone investigating " + topicQuery + "?",
                        "What are the current trends in " + topicQuery + " research?",
                        "Who is studying " + topicQuery + "?",
                        "What are the most common keywords in " + topicQuery + " research?",
                        "What are the most common study designs in " + topicQuery + " research?"
                    ];
                    var randomQuery = queryTemplate[Math.floor(Math.random() * queryTemplate.length)];
                }
                sendMessage(randomQuery);
            });

            $('#user-input').keypress(function (e) {
                if (e.which == 13) { // Enter key pressed
                    $('#send-btn').click();
                }
            });

            $('#toggle-mode-btn').click(function () {
                $('body').toggleClass('dark-mode light-mode');
                $('i', this).toggleClass('fa-sun fa-moon');
            });

            $('#export-btn').click(function () {
                window.location.href = "{{ url_for('export_chat_history') }}";
            });

            // Clear chat history with confirmation
            $('#clear-chat-btn').click(function () {
                if (confirm("Are you sure you want to clear the chat history?")) {
                    $.post("{{ url_for('clear_history') }}", function (data) {
                        if (data.status === 'success') {
                            $('#chat-box').empty();  // Clear the chat box in the frontend
                            $('#chat-box').append('<div class="chat-message bot-message">You have cleared the chat history. What can I help you find today?</div>');
                        }
                    });
                }
            });
        });
    </script>
</body>

</html>
